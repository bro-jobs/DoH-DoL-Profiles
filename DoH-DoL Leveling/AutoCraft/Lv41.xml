<?xml version="1.0" encoding="UTF-8"?>
<Profile>
<Name>Crafting Lv41 Gear</Name>
<Order>
    <RunCode Name="SwitchCombatJob"/>
    <If Condition="ItemCount(2657) &lt; 1">
        <GetTo ZoneId="139" XYZ="237.82053, -0.9224499, 248.70209"/>
        <BuyItem ItemIds="2657" ItemCount="1" NpcId="1003270" DialogOption="5" XYZ="234.48535, -0.91215116, 248.27954" />
        <WaitTimer WaitTime="2"/>
    </If>
    <If Condition="ItemCount(3012) &lt; 1">
        <GetTo ZoneId="139" XYZ="237.82053, -0.9224499, 248.70209"/>
        <BuyItem ItemIds="3012"  ItemCount="1" NpcId="1003270"  DialogOption="5" XYZ="234.48535, -0.91215116, 248.27954" />
        <WaitTimer WaitTime="2"/>
    </If>
    <If Condition="ItemCount(3602) &lt; 1">
        <GetTo ZoneId="139" XYZ="237.82053, -0.9224499, 248.70209"/>
        <BuyItem ItemIds="3602"  ItemCount="1" NpcId="1003270"  DialogOption="5" XYZ="234.48535, -0.91215116, 248.27954" />
        <WaitTimer WaitTime="2"/>
    </If>
    <If Condition="ItemCount(3830) &lt; 1">
        <GetTo ZoneId="139" XYZ="237.82053, -0.9224499, 248.70209"/>
        <BuyItem ItemIds="3830"  ItemCount="1" NpcId="1003270"  DialogOption="5" XYZ="234.48535, -0.91215116, 248.27954" />
        <WaitTimer WaitTime="2"/>
    </If>

    <RunCode Name="SetLisbethJson" />
    <If Condition="ItemCount(2808) &gt; 0 AND ItemCount(3137) &gt; 0 AND ItemCount(2785) &gt; 0 AND ItemCount(3691) &gt; 0 AND ItemCount(3415) &gt; 0 AND ItemCount(3911) &gt; 0 AND ItemCount(4231) &gt; 0 AND ItemCount(4353) &gt; 0 AND ItemCount(4126) &gt; 0 AND ItemCount(4467) &gt; 1 AND ItemCount(2323) &gt; 0 AND ItemCount(2335) &gt; 0 AND ItemCount(2350) &gt; 0 AND ItemCount(2361) &gt; 0 AND ItemCount(2375) &gt; 0 AND ItemCount(2386) &gt; 0 AND ItemCount(2400) &gt; 0 AND ItemCount(2411) &gt; 0 AND ItemCount(2425) &gt; 0 AND ItemCount(2437) &gt; 0 AND ItemCount(2451) &gt; 0 AND ItemCount(2464) &gt; 0 AND ItemCount(2476) &gt; 0 AND ItemCount(2488) &gt; 0 AND ItemCount(2502) &gt; 0 AND ItemCount(2514) &gt; 0 AND ItemCount(2528) &gt; 0 AND ItemCount(2540) &gt; 0 AND ItemCount(2554) &gt; 0 AND ItemCount(2566) &gt; 0 AND ItemCount(4232) &gt; 0 AND ItemCount(4333) &gt; 0 AND ItemCount(4132) &gt; 0 AND ItemCount(4482) &gt; 1 AND ItemCount(3163) &gt; 0 AND ItemCount(3627) &gt; 0 AND ItemCount(3410) &gt; 0 AND ItemCount(3853) &gt; 0">
        <LogMessage Message="Crafted Lv41 Gear!"/>
        <AutoInventoryEquip/>
        <WaitTimer WaitTime="5"/>
	    <RunCode Name="Logger" />
    </If >
    
	<WaitTimer WaitTime="5"/>
    <LLoadProfile Path="../Start.xml"/>
</Order>
<CodeChunks>
<CodeChunk Name="SwitchCombatJob">
            <![CDATA[ 
            var Combat = Enumerable.Range(8, 11).Append(0).Append(36);
            var gearSets = GearsetManager.GearSets.Where(i => i.InUse && !Combat.Contains((int)i.Class)).ToList().OrderByDescending(i=> i.Gear.First().Item.ItemLevel);

            if (gearSets.Any())
            {
                gearSets.First().Activate();
                await Coroutine.Sleep(2000);
            }
            ]]>
        </CodeChunk>
<CodeChunk Name="SetLisbethJson">
<![CDATA[
    // Try to get profile path and construct relative path from there
    var profilePath = ff14bot.NeoProfiles.NeoProfileManager.CurrentProfile.Path;
    var profileDir = System.IO.Path.GetDirectoryName(profilePath);
    var jsonPath = System.IO.Path.Combine(profileDir, "../Lisbeth/GearSets/GEAR41.json");
    
    var json = System.IO.File.ReadAllText(jsonPath);
    var lisbeth = BotManager.Bots.FirstOrDefault(c => c.Name == "Lisbeth");
    if (lisbeth != null)
   {
       var lisbethObject = lisbeth.GetType().GetProperty("Lisbeth").GetValue(lisbeth);
       if (lisbethObject != null)
       {
           Func<Task> executeWithRetry = null;
           executeWithRetry = async () => {
               try 
               {
                   var orderMethod = lisbethObject.GetType().GetMethod("ExecuteOrders");
                   await (Task<bool>)orderMethod.Invoke(lisbethObject, new object[] { json, false });
               }
               catch (Exception ex) when (
                   ex.ToString().Contains("HttpRequestException") || 
                   ex.ToString().Contains("No response from the server") ||
                   ex.ToString().Contains("Max sessions reached")
               )
               {
                   // Log and stop gently
                   ff14bot.Helpers.Logging.Write("[MaxSessionRestarter] Attempting to stop Lisbeth gently...");
                   var stopGentlyMethod = lisbethObject.GetType().GetMethod("StopGently");
                   await (Task)stopGentlyMethod.Invoke(lisbethObject, null);
                   
                   // Log and try to exit crafting
                   ff14bot.Helpers.Logging.Write("[MaxSessionRestarter] Attempting to exit crafting state...");
                   try 
                   {
                       var exitCraftingMethod = lisbethObject.GetType().GetMethod("ExitCrafting");
                       await (Task<bool>)exitCraftingMethod.Invoke(lisbethObject, null);
                   }
                   catch {}
                   
                   // Log waiting period
                   ff14bot.Helpers.Logging.Write("[MaxSessionRestarter] Waiting 5 minutes before attempting restart...");
                   await Task.Delay(TimeSpan.FromMinutes(5));
                   
                   // Log and request restart
                   ff14bot.Helpers.Logging.Write("[MaxSessionRestarter] Requesting Lisbeth to restart orders...");
                   var restartMethod = lisbethObject.GetType().GetMethod("RequestRestart");
                   restartMethod.Invoke(lisbethObject, new object[] { json });
                   
                   await executeWithRetry();
               }
           };

           await executeWithRetry();
       }
   }
]]>
</CodeChunk>
<CodeChunk Name="Logger">
    <![CDATA[
        try
        {
            string workingDirectory = Directory.GetCurrentDirectory();
            string settingsPath = Path.Combine(workingDirectory, "Settings");
            string logFilePath = Path.Combine(settingsPath, $"autocraft.txt");
            
            File.AppendAllText(logFilePath, "craft41" + Environment.NewLine);
        }
        catch (Exception ex)
        {
        }
    ]]>
</CodeChunk>
</CodeChunks>
</Profile>